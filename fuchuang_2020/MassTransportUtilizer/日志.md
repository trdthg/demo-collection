# 一 . 工具

```python
1. Anaconda3(python3.x) + Tensorflow2.x 
```



# 二 . 预测模型**可行性**分析

需要解决的问题

1. 客流检测能力不足
2. 缺乏客流精准管控方法
3. 缺乏对突发客流的提前评估和预测

## 1. 影响因素

#### 一类影响因素

1. o 几月
2. o 星期几(0, 1, 2, 3, 4, 5, 6)
3. o 是否为节假日(1, 2, 3)
4. ? 时间小时(0, 1, 2,--, 11, 12,13, ---,16, 17, 18,---, 23, 24)
5. x 地铁几号线 ( 1, 2, 3, 4, 5, 10, 11, 12)  ( 废除)
6. ? 地铁站点等级 ( 待定 )
7. ? 票价
8. ? 温度(可选)
9. ? 天气(可选)

#### 其他影响因素 ( 先无视 )

1. 是否存在集体活动等突发可变因素( 应对突发客流的检测 )
2. 是否居于学校, 公园, 等场所附近(可能会影响站点等级划分)
3. 是否与前几天有关联
4. 是否有较大波动 ()
5. 与实际情况有较大误差的应对情况

## 2. 模型选择

* 参数动态可调节(时间, 站点, 路线)

* 具备实时计算能力
PS: 人家的16层VGG是现成的东西, 能直接复制粘贴的那种

1. SimpleRNN
2. LSTM
3. GRU
4. ConvLSTM



##  3. 结论日志


#### 1月27日

```python
# 1. 记录
1. 星期几: 周六日相对流量有小幅度提升 
2. 某月对流量有很大影响
3. 某日对流量几乎无影响
4. 地铁几号线, 地铁站点不适合作为输入特征
5. 票价暂时不知道怎么输入
6. 因为输入特征只有 (flow. month. 是否放假. 星期几), 计算强度很低, 将对所有站点单独计算相应模型
# 2. 模型 / 参数
# 经过n多次实验, 这玩意一层网络就够了
model = tf.keras.Sequential([
        GRU(100),  # x_train = np.reshape(x_train, (x_train.shape[0], 14, len(x_arr)))
        Dropout(0.5),
        Dense(1),
    ])
optimizer = tf.keras.optimizers.Adam(0.0001),
batch_size=1, epochs=50,
x_arr =  [ flow[0], ] + list(dayprop) + [month, int(anyday)]
```

<img src="img/image-20210127220611046.png" alt="image-20210127220611046" style="zoom: 50%;" />

# 三 . 统计任务

## 问题 / 解决方案

##### 思路

```python
#1. 推测乘客出行路线
	由于数据只给出了出入站名称及时间, 无法知道用户所经过的实际路线(换乘站),
    通过某知乎回答, 有以下几种方案:
        1. 最短路径(也许在这里要换成时间)
        2. 经过最少站
        3. 最少换乘站
        4. 最少票价(除非不同线路票价不同, 暂时没有验证)
        5. 多路径模型(即从A-B中间的多条路线都有不同的概率, 总和为1)|(但是没数据, 恐怕要自己设值)
#2. 客流量统计
	1. 车站进站量VS车站出站量
	2. 换乘客流量
	3. 线路客流量
	4. 线网客流量
	5. 站间断面客流量
#3. 预测客流量
	了解到ConvLSTM(卷积LSTM网络), 似乎可以用于预测
		实例: 用于给定卫星云图, 预测一段时间后的降雨
		问题: 选择此模型进行预测时需要手动制出训练用的热力图作为训练集
    
```

##### 接口 0.1

```json
1. 单站客流出入
[
    {
        id:"Sta", 
        in:100, 
        out:100
    }
]
2. 全网进出站分布矩阵
直接计数
[
    {
        id:1,
        stain:"Sta1",
        staout:"Sta2",
        flow:234,
    }
]
3. 全网OD矩阵
估算统计
[
    {
        id:1,
        stain:"Sta1",
        staout:"Sta2",
        flow:468,
    }
]

4. 全网断面流量

1. 筛选出一定时间段内的所有trips
2. 推测出trips的具体路径
3. 为所有相邻两点的断面流量加1
4. 统计完成

1. 初始为零
2. 开始统计第一个30分钟
	某相邻两站间断面流量 = 
	前一时段内的断面流量 + 
	(进站 - 出站(线网内的剩余人数)) * 进站的估算路径 
[
    {
        id:1,
        x1:"Sta1",
        x2:"Sta2",
        flow:234,
    }
]
	
	
```

##### 接口 0.2

```json
Subway Flow
1 单站客流出入 list1_month_day  
[
    {
        station:"Sta",  (换乘不计)
        in_flow:100, 
        out_flow:100,
        in_flow_plus:100, (换乘统计)
        out_flow_plus:100,
    }
]

2 全网OD矩阵(进出站分布矩阵) list2_month_day  
[
    {
        stain:"Sta1",
        staout:"Sta2",
        flow:234,      (从a->b, 换乘站不记)
        flow_plus:123, (从a->b, 换乘站统计)
    }
]

3. 全网断面流量 list3_minth_day (相邻站点间)
[
    {
        x1:"Sta1",
        x2:"Sta2",
        flow:234,
    }
]
4. 线路客流 list4_month_day
[
	{
		linename: Sta54,
		flow: 123,
	}
]
```



## 任务清单

### 1. 单月整体客流波动

##### API


| 计算范围 | 数据格式 |
| - | - |
| 单月整体 | 列表 |
| 单月各条线路 | 字典 |
| 单月各个站点(按线路划分) | 嵌套字典 |

```json
{
    ret:0
    data:{
    	all_flow:[12,34,432,54,7,86,454,432,767],  
        route_flow:{
            1号线:[1,2,45],
            2号线:[44,786]
            },
        sta_flow:{
            1号线:{
            sta1:{1:34,2:43},
            sta2:{6:43,8:234}
            },
            2号线:{
                sta4:{},
                sta5:{}
                },
            }
        },

}
```

##### 详细过程

```python
# 1. 单月整体
pandas直接根据月筛选统计数据
# 3. sta
先统计全部sta的每个月得到:
{
    sta63: {1:12, 2:34},
    sta45: {1:11, 2:53},
    sta127: {1:11, 2:53},
}
# 2. route
直接加和
```

### 2. 工作日和周末客流


| 统计对象 | 统计范围 | 数据结构 |
| - | - | - |
|   |   |   |
|   |   |   |
|   |   |   |

### 3. 但站点客流出/入站

### 4. 用户年龄结构

### 5. 早晚高峰客流站点分布

### 6. 站点OD客流量

### 7. 线路断面(按站点)流量

### 8. 自愿拓展分析
